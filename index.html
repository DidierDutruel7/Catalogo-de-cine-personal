<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catálogo de Cine</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  margin: 0;
  padding: 20px;
}

h1 {
  margin-bottom: 10px;
}

button {
  background: #333;
  color: #eee;
  border: 1px solid #555;
  padding: 5px 10px;
  cursor: pointer;
}

button:hover {
  background: #555;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #444;
  padding: 6px;
  text-align: left;
}

th {
  background: #222;
}

input[type="text"],
input[type="number"] {
  width: 100%;
  background: #000;
  color: #eee;
  border: 1px solid #555;
}

#contador {
  margin-top: 10px;
  font-size: 14px;
  opacity: 0.9;
}
</style>
</head>

<body>

<h1>Catálogo de Cine</h1>

<button id="addMovie">+ Añadir película</button>

<div id="contador">Vistas 0 · Pendientes 0 · Total 0</div>

<table>
<thead>
<tr>
  <th>Director</th>
  <th>Película</th>
  <th>Nacionalidad</th>
  <th>País</th>
  <th>Año</th>
  <th>Vista</th>
  <th>Portada</th>
  <th></th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
/* ===============================
   BASE DE DATOS (IndexedDB)
================================ */
let db;
const DB_NAME = "catalogoCine";
const STORE = "peliculas";

const request = indexedDB.open(DB_NAME, 1);

request.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains(STORE)) {
    db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
  }
};

request.onsuccess = e => {
  db = e.target.result;
  cargarPeliculas();
};

function guardarPelicula(data) {
  const tx = db.transaction(STORE, "readwrite");
  tx.objectStore(STORE).add(data);
}

function obtenerPeliculas(cb) {
  const tx = db.transaction(STORE, "readonly");
  const req = tx.objectStore(STORE).getAll();
  req.onsuccess = () => cb(req.result);
}

function actualizarPelicula(pelicula) {
  const tx = db.transaction(STORE, "readwrite");
  tx.objectStore(STORE).put(pelicula);
}

/* ===============================
   RENDER
================================ */
const tbody = document.querySelector("tbody");

function render(peliculas) {
  peliculas.sort((a,b)=>{
    if (a.director !== b.director) {
      return a.director.localeCompare(b.director);
    }
    return a.anio - b.anio;
  });

  tbody.innerHTML = "";

  peliculas.forEach(p => {
    const tr = document.createElement("tr");
    tr.dataset.id = p.id;

    tr.innerHTML = `
      <td><input type="text" value="${p.director}"></td>
      <td><input type="text" value="${p.pelicula}"></td>
      <td><input type="text" value="${p.nacionalidad}"></td>
      <td><input type="text" value="${p.pais}"></td>
      <td><input type="number" value="${p.anio}"></td>
      <td><input type="checkbox" ${p.vista ? "checked" : ""}></td>
      <td>
        <button data-action="subir">Subir</button>
        ${p.portada ? `<button data-action="ver">Ver</button>` : ""}
        <input type="file" accept="image/*" hidden>
      </td>
      <td><button data-action="eliminar">✕</button></td>
    `;
    tbody.appendChild(tr);
  });

  actualizarContadores(peliculas);
}

function cargarPeliculas() {
  obtenerPeliculas(render);
}

/* ===============================
   EVENTOS
================================ */
tbody.addEventListener("input", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = Number(tr.dataset.id);

  obtenerPeliculas(peliculas => {
    const p = peliculas.find(x => x.id === id);
    const inputs = tr.querySelectorAll("input");

    p.director = inputs[0].value;
    p.pelicula = inputs[1].value;
    p.nacionalidad = inputs[2].value;
    p.pais = inputs[3].value;
    p.anio = inputs[4].value;

    actualizarPelicula(p);
  });
});

tbody.addEventListener("click", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = Number(tr.dataset.id);

  obtenerPeliculas(peliculas => {
    const p = peliculas.find(x => x.id === id);

    if (e.target.dataset.action === "eliminar") {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).delete(id);
      cargarPeliculas();
    }

    if (e.target.dataset.action === "subir") {
      tr.querySelector("input[type=file]").click();
    }

    if (e.target.dataset.action === "ver") {
      const img = document.createElement("img");
      img.src = p.portada;
      img.style.maxWidth = "90%";

      const modal = document.createElement("div");
      modal.style = `
        position:fixed;inset:0;
        background:rgba(0,0,0,.85);
        display:flex;align-items:center;justify-content:center;
      `;
      modal.appendChild(img);
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }
  });
});

tbody.addEventListener("change", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = Number(tr.dataset.id);

  obtenerPeliculas(peliculas => {
    const p = peliculas.find(x => x.id === id);

    if (e.target.type === "checkbox") {
      p.vista = e.target.checked;
      actualizarPelicula(p);
      actualizarContadores(peliculas);
    }

    if (e.target.type === "file") {
      const reader = new FileReader();
      reader.onload = () => {
        p.portada = reader.result;
        actualizarPelicula(p);
        cargarPeliculas();
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
});

/* ===============================
   CONTADORES
================================ */
function actualizarContadores(peliculas) {
  const vistas = peliculas.filter(p => p.vista).length;
  const total = peliculas.length;
  document.querySelector("#contador").textContent =
    `Vistas ${vistas} · Pendientes ${total - vistas} · Total ${total}`;
}

/* ===============================
   AÑADIR
================================ */
document.querySelector("#addMovie").onclick = () => {
  guardarPelicula({
    director:"",
    pelicula:"",
    nacionalidad:"",
    pais:"",
    anio:"",
    vista:false,
    portada:null
  });
  cargarPeliculas();
};
</script>

</body>
</html>
