<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catálogo de Cine</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  margin: 0;
  padding: 20px;
}

h1 { margin-bottom: 10px; }

button {
  background: #333;
  color: #eee;
  border: 1px solid #555;
  padding: 5px 10px;
  cursor: pointer;
}

button:hover { background: #555; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #444;
  padding: 6px;
  text-align: left;
}

th { background: #222; }

input[type="text"],
input[type="number"] {
  width: 100%;
  background: transparent;
  color: #eee;
  border: none;
  outline: none;
}

input[type="checkbox"] {
  transform: scale(1.1);
}

#contador {
  margin-top: 10px;
  font-size: 14px;
  opacity: .9;
}
</style>
</head>

<body>

<h1>Catálogo de Cine</h1>
<button id="addMovie">+ Añadir película</button>
<div id="contador">Vistas 0 · Pendientes 0 · Total 0</div>

<table>
<thead>
<tr>
  <th>Director</th>
  <th>Película</th>
  <th>Nacionalidad</th>
  <th>País</th>
  <th>Año</th>
  <th>Vista</th>
  <th>Portada</th>
  <th></th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let db;
const DB_NAME = "catalogoCine";
const STORE = "peliculas";

indexedDB.open(DB_NAME, 1).onupgradeneeded = e => {
  const db = e.target.result;
  db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
};

indexedDB.open(DB_NAME, 1).onsuccess = e => {
  db = e.target.result;
  cargarPeliculas();
};

function guardarPelicula(p) {
  db.transaction(STORE, "readwrite").objectStore(STORE).add(p);
}

function obtenerPeliculas(cb) {
  db.transaction(STORE).objectStore(STORE).getAll().onsuccess =
    e => cb(e.target.result);
}

function actualizarPelicula(p) {
  db.transaction(STORE, "readwrite").objectStore(STORE).put(p);
}

const tbody = document.querySelector("tbody");

function render(peliculas) {
  peliculas.sort((a,b)=>{
    if (a.director !== b.director) {
      return a.director.localeCompare(b.director);
    }
    return a.anio - b.anio;
  });

  tbody.innerHTML = "";

  peliculas.forEach(p => {
    const tr = document.createElement("tr");
    tr.dataset.id = p.id;

    tr.innerHTML = `
      <td><input data-field="director" value="${p.director}"></td>
      <td><input data-field="pelicula" value="${p.pelicula}"></td>
      <td><input data-field="nacionalidad" value="${p.nacionalidad}"></td>
      <td><input data-field="pais" value="${p.pais}"></td>
      <td><input data-field="anio" type="number" value="${p.anio}"></td>
      <td><input data-field="vista" type="checkbox" ${p.vista ? "checked" : ""}></td>
      <td>
        <button data-action="subir">Subir</button>
        ${p.portada ? `<button data-action="ver">Ver</button>` : ""}
        <input type="file" accept="image/*" hidden>
      </td>
      <td><button data-action="eliminar">✕</button></td>
    `;
    tbody.appendChild(tr);
  });

  actualizarContadores(peliculas);
}

function cargarPeliculas() {
  obtenerPeliculas(render);
}

tbody.addEventListener("input", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;

  const id = +tr.dataset.id;

  obtenerPeliculas(peliculas => {
    const p = peliculas.find(x => x.id === id);
    if (!p) return;

    p.director = tr.querySelector('[data-field="director"]').value;
    p.pelicula = tr.querySelector('[data-field="pelicula"]').value;
    p.nacionalidad = tr.querySelector('[data-field="nacionalidad"]').value;
    p.pais = tr.querySelector('[data-field="pais"]').value;
    p.anio = +tr.querySelector('[data-field="anio"]').value;

    actualizarPelicula(p);
  });
});

tbody.addEventListener("change", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = +tr.dataset.id;

  obtenerPeliculas(peliculas => {
    const p = peliculas.find(x => x.id === id);

    if (e.target.type === "checkbox") {
      p.vista = e.target.checked;
      actualizarPelicula(p);
      actualizarContadores(peliculas);
    }

    if (e.target.type === "file") {
      const reader = new FileReader();
      reader.onload = () => {
        p.portada = reader.result;
        actualizarPelicula(p);
        cargarPeliculas();
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
});

tbody.addEventListener("click", e => {
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = +tr.dataset.id;

  if (e.target.dataset.action === "eliminar") {
    db.transaction(STORE,"readwrite").objectStore(STORE).delete(id);
    cargarPeliculas();
  }

  if (e.target.dataset.action === "subir") {
    tr.querySelector('input[type="file"]').click();
  }

  if (e.target.dataset.action === "ver") {
    obtenerPeliculas(peliculas => {
      const p = peliculas.find(x => x.id === id);
      const modal = document.createElement("div");
      modal.style = "position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center";
      modal.innerHTML = `<img src="${p.portada}" style="max-width:90%">`;
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    });
  }
});

function actualizarContadores(peliculas) {
  const vistas = peliculas.filter(p => p.vista).length;
  document.querySelector("#contador").textContent =
    `Vistas ${vistas} · Pendientes ${peliculas.length - vistas} · Total ${peliculas.length}`;
}

document.querySelector("#addMovie").onclick = () => {
  guardarPelicula({
    director:"", pelicula:"", nacionalidad:"",
    pais:"", anio:"", vista:false, portada:null
  });
  cargarPeliculas();
};
</script>

</body>
</html>
